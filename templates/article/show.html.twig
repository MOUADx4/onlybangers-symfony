{% extends 'base.html.twig' %}

{% block title %}{{ article.title }}{% endblock %}

{% block body %}

<div class="container py-5">

    {# SECTION AVEC BORDURE NOIRE (S'ARR√äTE AVANT LES COMMENTAIRES) #}
    <article class="mx-auto section-bordered" style="max-width: 1250px;">

        {# Titre + bouton favoris #}
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h1 class="fw-bold m-0">{{ article.title }}</h1>

            <a href="{{ path('article_favorite', {id: article.id}) }}"
               class="fs-3 text-decoration-none"
               style="cursor:pointer;">
                {% if app.user and article in app.user.favorites %}
                    <span style="color:red;">üñ§</span>
                {% else %}
                    <span style="color:grey;">‚ô°</span>
                {% endif %}
            </a>
        </div>

        {# Notation √©toiles #}
        <div class="mb-3">
            {% for i in 1..5 %}
                <a href="{{ path('article_rate', {id: article.id, value: i}) }}"
                   class="text-decoration-none fs-4">
                    {% if i <= averageRating %}
                        ‚≠ê
                    {% else %}
                        ‚òÜ
                    {% endif %}
                </a>
            {% endfor %}
        </div>

        <p class="text-muted mb-1">
            Post√© par <strong>{{ article.author.username }}</strong>
            le {{ article.createdAt|date('d/m/Y H:i') }}
        </p>

        <hr class="my-4">

        {# IMAGE FULL (PAS DE BORDURE) #}
        {% if article.image %}
            <div class="text-center mb-4">
                <img 
                    src="{{ asset('uploads/articles/' ~ article.image) }}" 
                    alt="{{ article.title }}" 
                    class="img-fluid"
                    style="max-height: 500px; object-fit: contain; width: 100%; border-radius: 12px;">
            </div>
        {% endif %}

        {# Contenu #}
        <div class="mb-4 fs-5" style="line-height: 1.7;">
            {{ article.content|nl2br }}
        </div>

    </article> {# ‚Üê LA BORDURE S‚ÄôARR√äTE ICI #}



    {# ============================
       COMMENTAIRES (PAS DE BORDURE)
       ============================ #}

    <h3 class="fw-bold mt-5 mb-3">Commentaires</h3>

    {# ‚úÖ Pagination : commentsPagination #}
    {% if commentsPagination is empty %}
        <p class="text-muted">Aucun commentaire pour le moment.</p>
    {% else %}
        {% for comment in commentsPagination %}
            <div class="p-3 mb-3 border rounded bg-dark text-white">

                <div class="fw-bold">
                    {{ comment.author.username }}
                    <span class="text-muted ms-2">{{ comment.createdAt|date('d/m/Y H:i') }}</span>
                </div>

                <div class="mt-2">
                    {{ comment.content|nl2br }}
                </div>

                <div class="mt-2">
                    <a href="{{ path('comment_like', {id: comment.id}) }}" 
                       class="text-decoration-none text-light">
                        üëç {{ comment.likes|length }}
                    </a>

                    {% if app.user %}
                        <a href="#" class="ms-3 text-secondary"
                           onclick="document.getElementById('reply-{{ comment.id }}').style.display='block';">
                            R√©pondre
                        </a>
                    {% endif %}
                </div>

                {% if app.user %}
                    <div id="reply-{{ comment.id }}" style="display:none;" class="mt-2">
                        {{ form_start(replyForms[comment.id]) }}
                        {{ form_row(replyForms[comment.id].content) }}
                        <button class="btn btn-secondary btn-sm">Envoyer</button>
                        {{ form_end(replyForms[comment.id]) }}
                    </div>
                {% endif %}

                {% for reply in comment.replies %}
                    <div class="mt-3 ms-4 p-2 border-start">
                        <strong>{{ reply.author.username }}</strong>
                        <span class="text-muted ms-2">{{ reply.createdAt|date('d/m/Y H:i') }}</span>
                        <div>{{ reply.content|nl2br }}</div>
                    </div>
                {% endfor %}

            </div>
        {% endfor %}
    {% endif %}

    {# ‚úÖ Liens pagination commentaires #}
    <div class="d-flex justify-content-center mt-4">
        {{ knp_pagination_render(commentsPagination) }}
    </div>



    {% if app.user %}
        <h4 class="mt-4">Ajouter un commentaire</h4>

        {{ form_start(comment_form) }}
            {{ form_row(comment_form.content) }}
            <button class="btn btn-secondary mt-2">Envoyer</button>
        {{ form_end(comment_form) }}
    {% else %}
        <p class="text-muted mt-4">
            Vous devez √™tre connect√© pour poster un commentaire.
        </p>
        <a href="{{ path('app_login') }}" class="btn btn-secondary">
            Se connecter
        </a>
    {% endif %}

    <a href="{{ path('article_list') }}" 
       class="text-secondary text-decoration-none fw-bold mt-4 d-inline-block">
        ‚Üê Retour √† la liste des articles
    </a>

</div>

<style>
.section-bordered {
    border: 3px solid #000;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
}
</style>

{% endblock %}
